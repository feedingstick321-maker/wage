<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>경기도교육청 수도광열비 계산기(by 손샐파)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            /* 텍스트 드래그 선택 방지 */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        /* 입력창은 선택 가능해야 함 */
        input, select {
            -webkit-user-select: auto;
            -moz-user-select: auto;
            -ms-user-select: auto;
            user-select: auto;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // 아이콘 컴포넌트
        const CalculatorIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/>
            </svg>
        );
        const RotateCcwIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/>
            </svg>
        );

        const PublicUtilityCalculator = () => {
            // 보안 스크립트 추가
            useEffect(() => {
                // 1. 우클릭 방지
                const handleContextMenu = (e) => {
                    e.preventDefault();
                    return false;
                };

                // 2. 개발자 도구(F12, Ctrl+Shift+I) 및 소스보기(Ctrl+U) 방지
                const handleKeyDown = (e) => {
                    if (
                        e.key === 'F12' || 
                        (e.ctrlKey && e.shiftKey && e.key === 'I') || 
                        (e.ctrlKey && e.shiftKey && e.key === 'J') || 
                        (e.ctrlKey && e.shiftKey && e.key === 'C') || 
                        (e.ctrlKey && e.key === 'u')
                    ) {
                        e.preventDefault();
                        return false;
                    }
                };

                document.addEventListener('contextmenu', handleContextMenu);
                document.addEventListener('keydown', handleKeyDown);

                return () => {
                    document.removeEventListener('contextmenu', handleContextMenu);
                    document.removeEventListener('keydown', handleKeyDown);
                };
            }, []);

            // 입력 상태
            const [materialCost, setMaterialCost] = useState(0);
            const [laborCost, setLaborCost] = useState(0);
            
            // 요율 선택 상태
            const [selectedTypeRate, setSelectedTypeRate] = useState(0);
            const [selectedDurationRate, setSelectedDurationRate] = useState(0);
            const [selectedScaleRate, setSelectedScaleRate] = useState(0);
            
            // 결과 상태
            const [baseAmount, setBaseAmount] = useState(0);
            const [avgRate, setAvgRate] = useState(0);
            const [finalAmount, setFinalAmount] = useState(0);
            
            // 검증용 상태 (실제 계산에 쓰인 반올림된 값)
            const [debugRates, setDebugRates] = useState({ r1: 0, r2: 0, r3: 0 });

            // 데이터 정의
            const rateData = {
                type: [
                    { name: '건축', rate: 0.47927877116286127 },
                    { name: '토목', rate: 0.59679506317845665 },
                    { name: '산업설비', rate: 0.422 },
                    { name: '조경', rate: 0.360 }
                ],
                duration: [
                    { name: '6개월 이하', rate: 0.232 },
                    { name: '6개월 초과 ~ 12개월 이하', rate: 0.410 },
                    { name: '12개월 초과 ~ 36개월 이하', rate: 0.509 },
                    { name: '36개월 초과', rate: 0.596 }
                ],
                scale: [
                    { name: '5억 미만', rate: 0.154 },
                    { name: '5억 ~ 30억 미만', rate: 0.199 },
                    { name: '30억 ~ 50억 미만', rate: 0.232 },
                    { name: '50억 ~ 300억 미만', rate: 0.232 },
                ]
            };

            // 소수점 4째자리 반올림하여 3째자리까지 표시 함수
            const roundRate = (num) => {
                return Math.round(Number(num) * 1000) / 1000;
            };

            // 초기값 설정
            useEffect(() => {
                setSelectedTypeRate(rateData.type[0].rate);
                setSelectedDurationRate(rateData.duration[0].rate);
                setSelectedScaleRate(rateData.scale[0].rate);
            }, []);

            // 계산 로직
            useEffect(() => {
                const sum = Number(materialCost) + Number(laborCost);
                setBaseAmount(sum);

                const r1 = roundRate(selectedTypeRate);
                const r2 = roundRate(selectedDurationRate);
                const r3 = roundRate(selectedScaleRate);
                setDebugRates({ r1, r2, r3 });

                const rawAverage = (r1 + r2 + r3) / 3;
                const finalAverageRate = roundRate(rawAverage);
                setAvgRate(finalAverageRate);

                const calculated = sum * (finalAverageRate / 100) * 0.9;

                const truncatedResult = Math.floor(calculated / 10) * 10;
                setFinalAmount(truncatedResult);

            }, [materialCost, laborCost, selectedTypeRate, selectedDurationRate, selectedScaleRate]);

            const handleReset = () => {
                setMaterialCost(0);
                setLaborCost(0);
                setSelectedTypeRate(rateData.type[0].rate);
                setSelectedDurationRate(rateData.duration[0].rate);
                setSelectedScaleRate(rateData.scale[0].rate);
            };

            const formatNumber = (num) => {
                if (!num) return "0";
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            };

            const formatRateDisplay = (num) => {
                return roundRate(num).toFixed(3);
            }

            const handleInputChange = (setter) => (e) => {
                const value = e.target.value.replace(/[^0-9]/g, '');
                setter(Number(value));
            };

            return (
                <div className="p-4 md:p-8 font-sans max-w-2xl mx-auto">
                    <div className="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
                        {/* Header */}
                        <div className="bg-indigo-600 p-6 text-white flex justify-between items-center">
                            <div>
                                <h1 className="text-lg md:text-2xl font-bold flex items-center gap-2 tracking-tight">
                                    <CalculatorIcon className="w-5 h-5 md:w-6 md:h-6 shrink-0" />
                                    경기도교육청 수도광열비 계산기(by 손샐파)
                                </h1>
                                <p className="text-indigo-100 text-xs md:text-sm mt-1">완성공사 원가통계기준(2천만원이상 공사시 적용)</p>
                            </div>
                            <button 
                                onClick={handleReset}
                                className="bg-indigo-500 hover:bg-indigo-400 text-white p-2 rounded-lg transition-colors flex items-center gap-1 text-sm shrink-0 ml-3 md:ml-4"
                            >
                                <RotateCcwIcon className="w-4 h-4" />
                                <span className="hidden md:inline">초기화</span>
                            </button>
                        </div>

                        <div className="p-6 space-y-8">
                            {/* Section 1: 비용 입력 */}
                            <section className="space-y-4">
                                <h2 className="text-lg font-semibold text-gray-800 border-l-4 border-green-500 pl-3">
                                    1. 비용 입력 (직접비)
                                </h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-green-50 p-4 rounded-xl border border-green-100">
                                        <label className="block text-sm font-medium text-green-800 mb-1">직접재료비 (원)</label>
                                        <div className="relative">
                                            <input
                                                type="text"
                                                value={materialCost === 0 ? '' : formatNumber(materialCost)}
                                                onChange={handleInputChange(setMaterialCost)}
                                                placeholder="0"
                                                className="w-full text-right p-3 rounded-lg border border-green-300 focus:ring-2 focus:ring-green-500 outline-none text-lg font-bold text-gray-700 placeholder-gray-300"
                                            />
                                        </div>
                                    </div>
                                    
                                    <div className="bg-green-50 p-4 rounded-xl border border-green-100">
                                        <label className="block text-sm font-medium text-green-800 mb-1">직접노무비 (원)</label>
                                        <div className="relative">
                                            <input
                                                type="text"
                                                value={laborCost === 0 ? '' : formatNumber(laborCost)}
                                                onChange={handleInputChange(setLaborCost)}
                                                placeholder="0"
                                                className="w-full text-right p-3 rounded-lg border border-green-300 focus:ring-2 focus:ring-green-500 outline-none text-lg font-bold text-gray-700 placeholder-gray-300"
                                            />
                                        </div>
                                    </div>
                                </div>
                                <div className="text-right text-sm text-gray-500">
                                    합계: <span className="font-bold text-gray-700">{formatNumber(baseAmount)}</span> 원
                                </div>
                            </section>

                            {/* Section 2: 기준 선택 */}
                            <section className="space-y-4">
                                <h2 className="text-lg font-semibold text-gray-800 border-l-4 border-blue-500 pl-3">
                                    2. 적용 기준 선택 (3가지 필수)
                                </h2>
                                <p className="text-xs text-blue-600 mb-2 ml-3">* 개별 요율 및 평균 요율은 소수점 4째자리에서 반올림하여 적용합니다.</p>
                                
                                <div className="space-y-3">
                                    {/* 공사 종류 */}
                                    <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 flex flex-col md:flex-row md:items-center justify-between gap-2">
                                        <label className="text-sm font-medium text-blue-900 w-32 shrink-0">① 공사 종류</label>
                                        <select 
                                            className="flex-1 p-2 rounded-lg border border-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            onChange={(e) => setSelectedTypeRate(e.target.value)}
                                            value={selectedTypeRate}
                                        >
                                            {rateData.type.map((opt, i) => (
                                                <option key={i} value={opt.rate}>{opt.name} ({formatRateDisplay(opt.rate)}%)</option>
                                            ))}
                                        </select>
                                    </div>

                                    {/* 공사 기간 */}
                                    <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 flex flex-col md:flex-row md:items-center justify-between gap-2">
                                        <label className="text-sm font-medium text-blue-900 w-32 shrink-0">② 공사 기간</label>
                                        <select 
                                            className="flex-1 p-2 rounded-lg border border-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            onChange={(e) => setSelectedDurationRate(e.target.value)}
                                            value={selectedDurationRate}
                                        >
                                            {rateData.duration.map((opt, i) => (
                                                <option key={i} value={opt.rate}>{opt.name} ({formatRateDisplay(opt.rate)}%)</option>
                                            ))}
                                        </select>
                                    </div>

                                    {/* 공사 규모 */}
                                    <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 flex flex-col md:flex-row md:items-center justify-between gap-2">
                                        <label className="text-sm font-medium text-blue-900 w-32 shrink-0">③ 공사 규모</label>
                                        <select 
                                            className="flex-1 p-2 rounded-lg border border-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            onChange={(e) => setSelectedScaleRate(e.target.value)}
                                            value={selectedScaleRate}
                                        >
                                            {rateData.scale.map((opt, i) => (
                                                <option key={i} value={opt.rate}>{opt.name} ({formatRateDisplay(opt.rate)}%)</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                            </section>

                            <hr className="border-gray-200" />

                            {/* Section 3: 결과 */}
                            <section className="bg-gray-800 text-white rounded-2xl p-6 shadow-lg">
                                <h2 className="text-lg font-semibold mb-4 text-gray-300 flex items-center gap-2">
                                    <CalculatorIcon className="w-5 h-5" />
                                    최종 계산 결과
                                </h2>
                                
                                <div className="space-y-3 text-sm text-gray-400 mb-6">
                                    <div className="flex justify-between items-center">
                                        <span>대상 금액 (재료비+노무비)</span>
                                        <span className="text-white">{formatNumber(baseAmount)} 원</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span>최종 평균 요율 (반올림 적용됨)</span>
                                        <span className="text-yellow-400">{avgRate.toFixed(3)} %</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span>조정 계수</span>
                                        <span className="text-yellow-400">90 %</span>
                                    </div>
                                </div>

                                <div className="bg-gray-700 rounded-xl p-4 flex flex-col items-end border border-gray-600">
                                    <span className="text-sm text-gray-300 mb-1">최종 공공요금 (원단위 절사)</span>
                                    <div className="text-3xl font-bold text-white tracking-tight">
                                        {formatNumber(finalAmount)} 
                                        <span className="text-lg font-normal ml-1 text-gray-400">원</span>
                                    </div>
                                </div>
                                <div className="text-xs text-center text-gray-500 mt-4 bg-gray-900 bg-opacity-50 p-3 rounded-lg">
                                    <p className="mb-2 text-gray-300 font-medium border-b border-gray-600 pb-1">계산 상세 검증</p>
                                    <div className="flex flex-col gap-1 text-gray-400">
                                        <div className="flex justify-between">
                                            <span>선택 요율 합계:</span>
                                            <span>{debugRates.r1.toFixed(3)} + {debugRates.r2.toFixed(3)} + {debugRates.r3.toFixed(3)}</span>
                                        </div>
                                        <div className="flex justify-between border-t border-gray-700 pt-1 mt-1">
                                            <span>평균 반올림:</span>
                                            <span>({((debugRates.r1 + debugRates.r2 + debugRates.r3)/3).toFixed(4)}... → {avgRate.toFixed(3)}) %</span>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PublicUtilityCalculator />);
    </script>
</body>
</html>
